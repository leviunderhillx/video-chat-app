<!DOCTYPE html>
<html>
<head>
<title>WebRTC Video Chat</title>
<style>
body {
    font-family: sans-serif;
}
video {
    width: 320px;
    height: 240px;
}
</style>
</head>
<body>
    <h1>WebRTC Video Chat</h1>
    <div id="status"></div>
    <button id="startButton">Start</button>
    <button id="endButton" disabled>End</button>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <script>
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const statusText = document.getElementById('status');
        const startButton = document.getElementById('startButton');
        const endButton = document.getElementById('endButton');
        let peerConnection;
        let dataChannel;


        const configuration = {
            iceServers: [
                {
                    urls: ['stun:stun.l.google.com:19302', 'stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302']
                }
            ]
        };

        const wsUrl = 'wss://video-chat-server-t6df.onrender.com'; // Ensure this URL is correct
        let ws;

        startButton.onclick = initiateCall;
        endButton.onclick = endVideoChat;

        function initiateCall() {
            startButton.disabled = true;
            endButton.disabled = false;
            statusText.textContent = 'Connecting...';

            navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            }).then(stream => {
                localVideo.srcObject = stream;
                peerConnection = new RTCPeerConnection(configuration);
                peerConnection.addTrack(stream.getVideoTracks()[0], stream);
                peerConnection.addTrack(stream.getAudioTracks()[0], stream);

                peerConnection.oniceconnectionstatechange = () => {
                    console.log('Initiator ICE state:', peerConnection.iceConnectionState);
                    if (peerConnection.iceConnectionState === 'disconnected') {
                        statusText.textContent = 'Disconnected';
                        endVideoChat();
                    } else if (peerConnection.iceConnectionState === 'connected') {
                        statusText.textContent = 'Connected';
                    } else if (peerConnection.iceConnectionState === 'failed') {
                        console.error('ICE connection failed. Attempting recovery...');
                        statusText.textContent = 'Connection failed, retrying...';
                        setTimeout(() => {
                            cleanupConnection();
                            initiateCall();
                        }, 2000);
                    }
                };

                peerConnection.onsignalingstatechange = () => {
                    console.log('Initiator signaling state:', peerConnection.signalingState);
                };

                peerConnection.onconnectionstatechange = () => {
                    console.log('Initiator connection state:', peerConnection.connectionState);
                    if (peerConnection.connectionState === 'failed') {
                        console.error('Connection state failed. Check network/firewall settings.');
                        statusText.textContent = 'Connection failed';
                    }
                };


                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        ws.send(JSON.stringify({
                            type: 'candidate',
                            candidate: event.candidate
                        }));
                    }
                };

                peerConnection.createOffer().then(offer => {
                    return peerConnection.setLocalDescription(offer);
                }).then(() => {
                    ws.send(JSON.stringify({
                        type: 'offer',
                        sdp: peerConnection.localDescription
                    }));
                }).catch(error => {
                    console.error('Error creating offer:', error);
                    statusText.textContent = 'Error creating offer';
                });

                ws = new WebSocket(wsUrl);
                ws.onopen = () => {
                    console.log('WebSocket connection opened.');
                };
                ws.onmessage = event => {
                    const message = JSON.parse(event.data);
                    if (message.type === 'answer') {
                        peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                    } else if (message.type === 'candidate') {
                        peerConnection.addIceCandidate(message.candidate);
                    }
                };
                ws.onclose = () => {
                    console.log('WebSocket connection closed.');
                    endVideoChat();
                };
                ws.onerror = error => {
                    console.error('WebSocket error:', error);
                    statusText.textContent = 'WebSocket error';
                };
            }).catch(error => {
                console.error('Error accessing media devices:', error);
                statusText.textContent = 'Error accessing media devices';
            });
        }

        function endVideoChat() {
            startButton.disabled = false;
            endButton.disabled = true;
            statusText.textContent = '';
            cleanupConnection();
        }

        function cleanupConnection() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (ws) {
                ws.close();
                ws = null;
            }
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
        }

        peerConnection.ontrack = event => {
            remoteVideo.srcObject = event.streams[0];
            peerConnection.oniceconnectionstatechange = () => {
                console.log('Receiver ICE state:', peerConnection.iceConnectionState);
                if (peerConnection.iceConnectionState === 'disconnected') {
                    statusText.textContent = 'Disconnected';
                    endVideoChat();
                } else if (peerConnection.iceConnectionState === 'connected') {
                    statusText.textContent = 'Connected';
                }
            };
        };
    </script>
</body>
</html>